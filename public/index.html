<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestão Pessoal – Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="header-info">
      <h1>Gestão Pessoal – Dashboard</h1>
      <div class="muted">API: <span id="apiUrl">http://localhost:3333</span></div>
    </div>
    <div class="user-session">
      <div class="user-info">
        <strong id="userName"></strong>
        <span class="badge" id="userRole"></span>
      </div>
      <button class="ghost small" id="btnLogout">Sair</button>
    </div>
  </header>

  <div class="container">
    <!-- COLUNA ESQUERDA: Transações -->
    <section class="card dashboard-card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 class="title">Transações</h2>
        <div class="tabs">
          <button class="tab active" data-tab="tab-form">Cadastro</button>
          <button class="tab" data-tab="tab-reports">Relatórios</button>
        </div>
      </div>

      <!-- Tab: Cadastro -->
      <div id="tab-form">
        <div class="row">
          <div style="flex:1">
            <label>Tipo</label>
            <select id="t-type">
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Valor (use ponto para decimais)</label>
            <input type="number" step="0.01" id="t-amount" placeholder="0.00">
          </div>
          <div style="flex:1">
            <label>Data</label>
            <input type="date" id="t-date">
          </div>
        </div>
        <div class="row">
          <div style="flex:2">
            <label>Descrição</label>
            <input id="t-desc" placeholder="Ex.: Venda no Pix">
          </div>
          <div style="flex:1">
            <label>Categoria</label>
            <input id="t-cat" placeholder="Ex.: Vendas/Estoque">
          </div>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="primary" id="btnAddTx">Adicionar</button>
          <button class="ghost" id="btnClearTx">Limpar</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div style="flex:1">
            <label>Filtro: de</label>
            <input type="date" id="f-from">
          </div>
          <div style="flex:1">
            <label>até</label>
            <input type="date" id="f-to">
          </div>
          <div style="flex:1">
            <label>Tipo</label>
            <select id="f-type">
              <option value="">Todos</option>
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Busca</label>
            <input id="f-q" placeholder="descrição ou categoria">
          </div>
          <div style="align-self:flex-end">
            <button id="btnFilter">Filtrar</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="summary">
          <div class="kpi">
            <small>Total Receitas</small>
            <strong id="kpiIncome">R$ 0,00</strong>
          </div>
          <div class="kpi">
            <small>Total Despesas</small>
            <strong id="kpiExpense">R$ 0,00</strong>
          </div>
          <div class="kpi">
            <small>Saldo</small>
            <strong id="kpiBalance">R$ 0,00</strong>
          </div>
        </div>

        <div class="sep"></div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th class="right">Valor</th>
                <th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="txTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Tab: Relatórios -->
      <div id="tab-reports" class="hidden">
        <p class="muted">Os gráficos respeitam os filtros de período e busca acima. Clique em <b>Filtrar</b> para atualizar.</p>
        <div class="row">
          <div class="card" style="flex:1">
            <h3 class="title">Receitas x Despesas (por mês)</h3>
            <canvas id="chartLine"></canvas>
          </div>
          <div class="card" style="flex:1">
            <h3 class="title">Despesas por Categoria</h3>
            <canvas id="chartPie"></canvas>
          </div>
        </div>
        <div class="row">
          <div class="card" style="flex:1">
            <h3 class="title">Receitas por Categoria</h3>
            <canvas id="chartIncomeCat"></canvas>
          </div>
          <div class="card" style="flex:1">
            <h3 class="title">Saldo Acumulado</h3>
            <canvas id="chartBalance"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- COLUNA DIREITA: Agenda -->
    <aside class="card">
      <h2 class="title">Agenda</h2>

      <div class="grid grid-2" style="margin-bottom:8px">
        <div>
          <label>Título</label>
          <input id="e-title" placeholder="Reunião, Médico, etc.">
        </div>
        <div>
          <label>Data</label>
          <input type="date" id="e-date">
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>Início</label>
          <input type="time" id="e-start">
        </div>
        <div>
          <label>Fim</label>
          <input type="time" id="e-end">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Notas</label>
        <textarea id="e-notes" placeholder="Observações do evento..."></textarea>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button class="primary" id="btnAddEvent">Adicionar Evento</button>
        <button class="ghost" id="btnClearEvent">Limpar</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1">
          <label>De</label>
          <input type="date" id="ef-from">
        </div>
        <div style="flex:1">
          <label>Até</label>
          <input type="date" id="ef-to">
        </div>
        <div style="flex:1">
          <label>Busca</label>
          <input id="ef-q" placeholder="título/notas">
        </div>
        <div style="align-self:flex-end">
          <button id="btnFilterEvents">Filtrar</button>
        </div>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto; max-height:480px">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Título</th>
              <th>Horário</th>
              <th>Notas</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="evTable"></tbody>
        </table>
      </div>
    </aside>

    <!-- ADMIN: GERENCIAR USUÁRIOS -->
    <section class="card admin-card" id="adminUsersSection" hidden>
      <h2 class="title">Gerenciar Usuários</h2>
      <p class="muted">Crie contas para seus amigos. Cada um verá apenas os próprios dados.</p>

      <div class="grid grid-2 admin-user-form">
        <div>
          <label>Nome</label>
          <input id="u-name" placeholder="Nome completo (opcional)">
        </div>
        <div>
          <label>Usuário</label>
          <input id="u-username" placeholder="ex.: joaosilva">
        </div>
        <div>
          <label>Senha inicial</label>
          <input id="u-password" type="password" placeholder="Mínimo de 4 caracteres">
        </div>
        <div>
          <label>WhatsApp</label>
          <input id="u-whatsapp" placeholder="+5511999999999">
        </div>
        <div class="admin-user-actions">
          <button class="primary" id="btnCreateUser">Adicionar usuário</button>
          <button class="ghost" id="btnClearUser">Limpar</button>
          <button class="primary" id="btnUpdateUser" hidden>Salvar alterações</button>
        </div>
      </div>

      <p class="muted hidden" id="userEditInfo"></p>

      <div class="sep"></div>

      <div class="user-list-wrapper">
        <table>
          <thead>
            <tr>
              <th>Usuário</th>
              <th>Nome</th>
              <th>WhatsApp</th>
              <th>Perfil</th>
              <th>Criado em</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
        <p class="muted user-empty hidden" id="userEmptyMessage">Nenhum usuário cadastrado além de você.</p>
      </div>
    </section>
  </div>

  <script>
    const apiLabel = document.getElementById('apiUrl');
    let API = sessionStorage.getItem('gp-api-base') || 'http://localhost:3333';
    const storedToken = sessionStorage.getItem('gp-auth-token');
    const storedUserRaw = sessionStorage.getItem('gp-user');

    let isSigningOut = false;

    const signOut = () => {
      if (isSigningOut) return;
      isSigningOut = true;
      const token = sessionStorage.getItem('gp-auth-token');
      const apiBase = sessionStorage.getItem('gp-api-base') || API;
      if (token) {
        fetch(`${apiBase}/api/auth/logout`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` }
        }).catch(() => {});
      }
      sessionStorage.removeItem('gp-auth-token');
      sessionStorage.removeItem('gp-user');
      sessionStorage.removeItem('gp-api-base');
      window.location.href = 'login.html';
    };

    if (!storedToken || !storedUserRaw) {
      signOut();
      throw new Error('Sessão expirada');
    }

    let currentUser;
    try {
      currentUser = JSON.parse(storedUserRaw);
    } catch (err) {
      console.error('Erro ao ler usuário em sessão', err);
      signOut();
      throw err;
    }

    if (!currentUser || !currentUser.username) {
      signOut();
      throw new Error('Usuário inválido');
    }

    let AUTH_TOKEN = storedToken;

    const userNameLabel = document.getElementById('userName');
    const userRoleLabel = document.getElementById('userRole');
    const logoutButton = document.getElementById('btnLogout');
    const agendaCard = document.querySelector('.container > aside.card');

    if (userNameLabel) userNameLabel.textContent = currentUser.name || currentUser.username;
    if (userRoleLabel) userRoleLabel.textContent = currentUser.role === 'admin' ? 'Administrador' : 'Usuário';
    if (logoutButton) logoutButton.onclick = () => signOut();
    if (agendaCard) agendaCard.classList.remove('hidden');

    const BRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const val = id => document.getElementById(id).value.trim();
    const set = (id,v)=> document.getElementById(id).value = v || '';
    const isValidWhatsapp = (value) => /^\+\d{6,15}$/.test(value);
    const today = () => new Date().toISOString().slice(0,10);

    // datas padrão
    set('t-date', today());
    set('e-date', today());
    set('f-from', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10));
    set('f-to', new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).toISOString().slice(0,10));
    set('ef-from', today());
    set('ef-to', today());

    let apiDetectionPromise;

    async function detectApiBase(){
      if (apiDetectionPromise) return apiDetectionPromise;
      apiDetectionPromise = (async () => {
        apiLabel.textContent = 'detectando...';
        const candidates = [];
        const seen = new Set();
        const stored = sessionStorage.getItem('gp-api-base');
        if (stored) candidates.push(stored);
        const metaTag = document.querySelector('meta[name="api-base"]');
        const meta = metaTag?.content?.trim();
        if (meta) candidates.push(meta);
        const origin = location.origin && location.origin !== 'null' ? location.origin : '';
        if (origin) candidates.push(origin);
        if (location.hostname) {
          const proto = location.protocol.startsWith('http') ? location.protocol : 'http:';
          const hostBase = `${proto}//${location.hostname}`;
          candidates.push(hostBase);
          candidates.push(`${hostBase}:3333`);
        }
        candidates.push('http://localhost:3333', 'http://127.0.0.1:3333');

        let resolved = false;
        for (const cand of candidates) {
          const normalized = cand.replace(/\/+$/, '');
          if (!normalized || seen.has(normalized)) continue;
          seen.add(normalized);
          try {
            const res = await fetch(`${normalized}/api/health`, { cache: 'no-store' });
            if (res.ok) {
              API = normalized;
              resolved = true;
              break;
            }
          } catch (err) {
            console.warn('Falha ao conectar com a API em', normalized, err);
          }
        }

        if (!resolved) console.warn('Nenhuma API respondeu, usando', API);
        apiLabel.textContent = resolved ? API : `${API} (offline?)`;
        sessionStorage.setItem('gp-api-base', API);
        return API;
      })();
      return apiDetectionPromise;
    }

    async function apiRequest(path, options = {}){
      const url = path.startsWith('http') ? path : `${API}${path}`;
      const opts = { ...options };
      opts.headers = { ...(options.headers || {}) };
      if (opts.body && !opts.headers['Content-Type']) {
        opts.headers['Content-Type'] = 'application/json';
      }
      if (AUTH_TOKEN) {
        opts.headers['Authorization'] = `Bearer ${AUTH_TOKEN}`;
      }
      const res = await fetch(url, opts);
      if (!res.ok) {
        let message = `HTTP ${res.status}`;
        try {
          const data = await res.json();
          if (data?.error) message = data.error;
        } catch {
          try {
            const text = await res.text();
            if (text) message = text;
          } catch {}
        }
        const error = new Error(message);
        error.status = res.status;
        if (res.status === 401) {
          signOut();
        }
        throw error;
      }
      if (res.status === 204) return null;
      const contentType = res.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        return res.json();
      }
      return res.text();
    }

    function showError(message, err){
      if (err?.status === 401) return;
      console.error(message, err);
      alert(message);
    }

    // ===== TABS =====
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-tab');
        document.getElementById('tab-form').classList.toggle('hidden', target!=='tab-form');
        document.getElementById('tab-reports').classList.toggle('hidden', target!=='tab-reports');
        if (agendaCard) agendaCard.classList.toggle('hidden', target === 'tab-reports');
        if(target==='tab-reports') updateCharts(); // atualiza gráficos ao abrir
      };
    });

    // ===== TRANSAÇÕES =====
    let cachedTx = [];

    async function loadTransactions(){
      try {
        const qs = new URLSearchParams();
        const from = val('f-from');
        const to = val('f-to');
        const type = val('f-type');
        const q = val('f-q');
        if(from) qs.append('from', from);
        if(to) qs.append('to', to);
        if(type) qs.append('type', type);
        if(q) qs.append('q', q);

        const query = qs.toString();
        const data = await apiRequest(`/api/transactions${query ? `?${query}` : ''}`);
        cachedTx = Array.isArray(data) ? data : [];
        renderTx(cachedTx);
        const summary = await fetchSummary(from, to);
        if (summary) renderSummary(summary);
        apiLabel.textContent = API;
        updateCharts();
      } catch (err) {
        showError('Não foi possível carregar as transações. Verifique se a API está em execução.', err);
      }
    }

    function renderTx(rows){
      const tb = document.getElementById('txTable');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const badge = `<span class="pill ${r.type}">${r.type === 'income' ? 'Receita' : 'Despesa'}</span>`;
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${badge}</td>
          <td>${r.description ?? ''}</td>
          <td>${r.category ?? ''}</td>
          <td class="right">${BRL(r.amount)}</td>
          <td class="actions">
            <button data-edit="${r.id}">Editar</button>
            <button class="danger" data-del="${r.id}">Excluir</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      // delete
      tb.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(!confirm('Excluir esta transação?')) return;
          try {
            await apiRequest(`/api/transactions/${id}`, { method:'DELETE' });
            await loadTransactions();
          } catch (err) {
            showError('Erro ao excluir a transação.', err);
          }
        };
      });
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-edit');
          const r = cachedTx.find(x=>x.id===id);
          if(!r) return;
          const type = prompt("Tipo (income/expense):", r.type) || r.type;
          const amount = parseFloat(prompt("Valor:", r.amount)) || r.amount;
          const description = prompt("Descrição:", r.description ?? '') ?? r.description;
          const category = prompt("Categoria:", r.category ?? '') ?? r.category;
          const date = prompt("Data (yyyy-mm-dd):", r.date) || r.date;
          try {
            await apiRequest(`/api/transactions/${id}`, {
              method:'PATCH',
              body: JSON.stringify({ type, amount, description, category, date })
            });
            await loadTransactions();
          } catch (err) {
            showError('Erro ao atualizar a transação.', err);
          }
        };
      });
    }

    async function fetchSummary(from, to){
      const qs = new URLSearchParams();
      if(from) qs.append('from', from);
      if(to) qs.append('to', to);
      const query = qs.toString();
      return apiRequest(`/api/transactions/summary${query ? `?${query}` : ''}`);
    }

    function renderSummary(s){
      const income = s?.income ?? 0;
      const expense = s?.expense ?? 0;
      const balance = s?.balance ?? (income - expense);
      document.getElementById('kpiIncome').textContent  = BRL(income);
      document.getElementById('kpiExpense').textContent = BRL(expense);
      document.getElementById('kpiBalance').textContent = BRL(balance);
    }

    document.getElementById('btnAddTx').onclick = async () => {
      const type = val('t-type');
      const amount = parseFloat(val('t-amount'));
      const date = val('t-date');
      if(!date || isNaN(amount) || amount < 0){ alert('Preencha a data e um valor válido.'); return; }
      const payload = {
        type, amount,
        description: val('t-desc') || null,
        category: val('t-cat') || null,
        date
      };
      try {
        await apiRequest('/api/transactions', {
          method:'POST',
          body: JSON.stringify(payload)
        });
        set('t-amount',''); set('t-desc',''); set('t-cat','');
        await loadTransactions();
      } catch (err) {
        showError(`Erro ao salvar a transação: ${err.message}`, err);
      }
    };

    document.getElementById('btnClearTx').onclick = () => {
      set('t-amount',''); set('t-desc',''); set('t-cat',''); set('t-date', today()); set('t-type','income');
    };
    document.getElementById('btnFilter').onclick = async ()=>{ await loadTransactions(); };

    // ===== EVENTOS =====
    async function loadEvents(){
      try {
        const qs = new URLSearchParams();
        const from = val('ef-from');
        const to = val('ef-to');
        const q = val('ef-q');
        if(from) qs.append('from', from);
        if(to) qs.append('to', to);
        if(q) qs.append('q', q);

        const query = qs.toString();
        const data = await apiRequest(`/api/events${query ? `?${query}` : ''}`);
        renderEvents(Array.isArray(data) ? data : []);
      } catch (err) {
        showError('Não foi possível carregar os eventos.', err);
      }
    }

    function renderEvents(rows){
      const tb = document.getElementById('evTable');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const hora = [r.start_time||'', r.end_time?`– ${r.end_time}`:''].join(' ').trim();
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.title}</td>
          <td>${hora || '-'}</td>
          <td>${r.notes ?? ''}</td>
          <td class="actions">
            <button data-edit="${r.id}">Editar</button>
            <button class="danger" data-del="${r.id}">Excluir</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(!confirm('Excluir este evento?')) return;
          try {
            await apiRequest(`/api/events/${id}`, { method:'DELETE' });
            await loadEvents();
          } catch (err) {
            showError('Erro ao excluir o evento.', err);
          }
        };
      });
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-edit');
          const r = rows.find(x=>x.id===id);
          if(!r) return;
          const title = prompt("Título:", r.title) ?? r.title;
          const date  = prompt("Data (yyyy-mm-dd):", r.date) || r.date;
          const start_time = prompt("Início (HH:mm):", r.start_time ?? '') || null;
          const end_time   = prompt("Fim (HH:mm):", r.end_time ?? '') || null;
          const notes = prompt("Notas:", r.notes ?? '') ?? r.notes;
          try {
            await apiRequest(`/api/events/${id}`, {
              method:'PATCH',
              body: JSON.stringify({ title, date, start_time, end_time, notes })
            });
            await loadEvents();
          } catch (err) {
            showError('Erro ao atualizar o evento.', err);
          }
        };
      });
    }

    document.getElementById('btnAddEvent').onclick = async () => {
      const title = val('e-title');
      const date = val('e-date');
      if(!title || !date){ alert('Preencha o título e a data do evento.'); return; }
      const payload = {
        title,
        date,
        start_time: val('e-start') || null,
        end_time: val('e-end') || null,
        notes: val('e-notes') || null
      };
      try {
        await apiRequest('/api/events', {
          method:'POST',
          body: JSON.stringify(payload)
        });
        set('e-title',''); set('e-start',''); set('e-end',''); set('e-notes',''); set('e-date', today());
        await loadEvents();
      } catch (err) {
        showError(`Erro ao salvar o evento: ${err.message}`, err);
      }
    };

    document.getElementById('btnClearEvent').onclick = () => {
      set('e-title',''); set('e-start',''); set('e-end',''); set('e-notes',''); set('e-date', today());
    };

    document.getElementById('btnFilterEvents').onclick = async () => { await loadEvents(); };

    // ===== GRÁFICOS (Chart.js) =====
    let chartLine, chartPie, chartIncomeCat, chartBalance;

    function groupByMonth(rows){
      const map = new Map();
      rows.forEach(r=>{
        const ym = r.date.slice(0,7);
        if(!map.has(ym)) map.set(ym, { income:0, expense:0 });
        map.get(ym)[r.type] += r.amount;
      });
      const labels = Array.from(map.keys()).sort();
      const incomes = labels.map(l => map.get(l).income);
      const expenses = labels.map(l => map.get(l).expense);
      return { labels, incomes, expenses };
    }

    function expenseByCategory(rows){
      const cat = {};
      rows.filter(r=>r.type==='expense').forEach(r=>{
        const c = r.category || 'Sem categoria';
        cat[c] = (cat[c]||0) + r.amount;
      });
      const labels = Object.keys(cat);
      const values = labels.map(k => cat[k]);
      return { labels, values };
    }

    function incomeByCategory(rows){
      const cat = {};
      rows.filter(r=>r.type==='income').forEach(r=>{
        const c = r.category || 'Sem categoria';
        cat[c] = (cat[c]||0) + r.amount;
      });
      const labels = Object.keys(cat);
      const values = labels.map(k => cat[k]);
      return { labels, values };
    }

    function cumulativeBalance(grouped){
      if (!grouped || !Array.isArray(grouped.labels) || grouped.labels.length === 0) {
        return { labels: ['Sem dados'], values: [0] };
      }
      let running = 0;
      const values = grouped.labels.map((label, idx) => {
        running += (grouped.incomes[idx] || 0) - (grouped.expenses[idx] || 0);
        return running;
      });
      return { labels: grouped.labels, values };
    }

    function destroyCharts(){
      if(chartLine){ chartLine.destroy(); chartLine=null; }
      if(chartPie){ chartPie.destroy(); chartPie=null; }
      if(chartIncomeCat){ chartIncomeCat.destroy(); chartIncomeCat=null; }
      if(chartBalance){ chartBalance.destroy(); chartBalance=null; }
    }

    function updateCharts(){
      destroyCharts();
      const rows = Array.isArray(cachedTx) ? cachedTx : [];

      const grouped = groupByMonth(rows);
      const pieData = expenseByCategory(rows);
      const incomeData = incomeByCategory(rows);
      const balanceData = cumulativeBalance(grouped);
      const hasLineData = grouped.labels.length > 0;
      const lineLabels = hasLineData ? grouped.labels : ['Sem dados'];
      const lineIncome = hasLineData ? grouped.incomes : [0];
      const lineExpense = hasLineData ? grouped.expenses : [0];
      const hasPieData = pieData.labels.length > 0;
      const pieLabels = hasPieData ? pieData.labels : ['Sem dados'];
      const pieValues = hasPieData ? pieData.values : [1];
      const hasIncomeData = incomeData.labels.length > 0;
      const incomeLabels = hasIncomeData ? incomeData.labels : ['Sem dados'];
      const incomeValues = hasIncomeData ? incomeData.values : [1];
      const balanceLabels = balanceData.labels.length > 0 ? balanceData.labels : ['Sem dados'];
      const balanceValues = balanceData.values.length > 0 ? balanceData.values : [0];

      const ctxL = document.getElementById('chartLine');
      const ctxP = document.getElementById('chartPie');
      const ctxIncome = document.getElementById('chartIncomeCat');
      const ctxBalance = document.getElementById('chartBalance');

      chartLine = new Chart(ctxL, {
        type: 'line',
        data: {
          labels: lineLabels,
          datasets: [
            { label: 'Receitas', data: lineIncome },
            { label: 'Despesas', data: lineExpense }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } },
            y: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } }
          }
        }
      });

      chartPie = new Chart(ctxP, {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieValues }] },
        options: { responsive: true, plugins: { legend: { labels: { color: '#e5e7eb' } } } }
      });

      chartIncomeCat = new Chart(ctxIncome, {
        type: 'bar',
        data: {
          labels: incomeLabels,
          datasets: [
            {
              label: 'Receitas',
              data: incomeValues,
              backgroundColor: 'rgba(34,197,94,0.6)',
              borderColor: 'rgba(34,197,94,1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } },
            y: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } }
          }
        }
      });

      chartBalance = new Chart(ctxBalance, {
        type: 'line',
        data: {
          labels: balanceLabels,
          datasets: [
            {
              label: 'Saldo acumulado',
              data: balanceValues,
              fill: true,
              tension: 0.3,
              backgroundColor: 'rgba(59,130,246,0.3)',
              borderColor: 'rgba(59,130,246,1)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } },
            y: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } }
          }
        }
      });
    }

    // ===== ADMIN / USUÁRIOS =====
    const adminSection = document.getElementById('adminUsersSection');
    const userTableBody = document.getElementById('userTableBody');
    const userEmptyMessage = document.getElementById('userEmptyMessage');
    const userEditInfo = document.getElementById('userEditInfo');
    const btnCreateUser = document.getElementById('btnCreateUser');
    const btnClearUser = document.getElementById('btnClearUser');
    const btnUpdateUser = document.getElementById('btnUpdateUser');
    const passwordInput = document.getElementById('u-password');
    const whatsappInput = document.getElementById('u-whatsapp');
    let editingUserId = null;

    function resetUserForm(){
      editingUserId = null;
      set('u-username', '');
      set('u-name', '');
      if (whatsappInput) whatsappInput.value = '';
      if (passwordInput) passwordInput.value = '';
      if (btnUpdateUser) btnUpdateUser.hidden = true;
      if (btnCreateUser) btnCreateUser.disabled = false;
      if (userEditInfo) {
        userEditInfo.textContent = '';
        userEditInfo.classList.add('hidden');
      }
      const rows = userTableBody ? Array.from(userTableBody.querySelectorAll('tr')) : [];
      rows.forEach((row) => row.classList.remove('is-editing'));
    }

    function startEditUser(user){
      if (!user) return;
      editingUserId = user.id;
      set('u-username', user.username || '');
      set('u-name', user.name || '');
      if (whatsappInput) whatsappInput.value = user.whatsapp || '';
      if (passwordInput) passwordInput.value = '';
      if (btnUpdateUser) btnUpdateUser.hidden = false;
      if (btnCreateUser) btnCreateUser.disabled = true;
      if (userEditInfo) {
        userEditInfo.textContent = `Editando usuário ${user.username}. Altere os campos e clique em "Salvar alterações".`;
        userEditInfo.classList.remove('hidden');
      }
      const rows = userTableBody ? Array.from(userTableBody.querySelectorAll('tr')) : [];
      rows.forEach((row) => {
        row.classList.toggle('is-editing', row.dataset.userId === user.id);
      });
      if (adminSection) {
        window.scrollTo({ top: adminSection.offsetTop - 40, behavior: 'smooth' });
      }
    }

    function renderManagedUsers(users){
      if (!userTableBody || !userEmptyMessage) return;
      userTableBody.innerHTML = '';
      if (!Array.isArray(users) || users.length === 0) {
        resetUserForm();
        userEmptyMessage.classList.remove('hidden');
        return;
      }
      userEmptyMessage.classList.add('hidden');
      const formatter = new Intl.DateTimeFormat('pt-BR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      users.forEach((user) => {
        const tr = document.createElement('tr');
        tr.dataset.userId = user.id;
        const createdAt = user.createdAt ? formatter.format(new Date(user.createdAt)) : '-';
        const roleLabel = user.role === 'admin' ? 'Administrador' : 'Usuário';
        tr.innerHTML = `
          <td>${user.username}</td>
          <td>${user.name ?? '-'}</td>
          <td>${user.whatsapp ? user.whatsapp : '-'}</td>
          <td>${roleLabel}</td>
          <td>${createdAt}</td>
          <td class="actions">
            <button type="button" class="icon-button btn-edit-user" data-user-id="${user.id}" title="Editar usuário" aria-label="Editar ${user.username}">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M14.612 2.19531C14.8946 1.9127 15.2695 1.75439 15.6594 1.75439C16.0492 1.75439 16.4242 1.9127 16.7068 2.19531L17.8047 3.2932C18.0873 3.57582 18.2456 3.95075 18.2456 4.34063C18.2456 4.73052 18.0873 5.10545 17.8047 5.38806L8.64305 14.5497C8.45396 14.7388 8.22169 14.8785 7.96865 14.9569L4.6875 15.9375L5.66814 12.6564C5.74646 12.4033 5.88619 12.1711 6.07529 11.982L15.237 2.82034L14.612 2.19531Z" fill="currentColor"/>
                <path d="M3.75 5.625H2.5C2.15482 5.625 1.875 5.90482 1.875 6.25V16.875C1.875 17.2202 2.15482 17.5 2.5 17.5H13.125C13.4702 17.5 13.75 17.2202 13.75 16.875V15.625H12.5V16.25H3.125V6.875H3.75V5.625Z" fill="currentColor"/>
              </svg>
            </button>
          </td>
        `;
        userTableBody.appendChild(tr);
        const editButton = tr.querySelector('.btn-edit-user');
        if (editButton) {
          editButton.onclick = () => startEditUser(user);
        }
        if (editingUserId && editingUserId === user.id) {
          tr.classList.add('is-editing');
        }
      });
      if (editingUserId && !users.some((user) => user.id === editingUserId)) {
        resetUserForm();
      }
    }

    async function loadManagedUsers(){
      if (!adminSection || currentUser.role !== 'admin') return;
      try {
        await detectApiBase();
        const users = await apiRequest('/api/users');
        renderManagedUsers(users);
      } catch (err) {
        showError('Não foi possível carregar a lista de usuários.', err);
      }
    }

    if (adminSection && currentUser.role === 'admin') {
      adminSection.hidden = false;
      loadManagedUsers();
    }

    if (btnCreateUser) {
      btnCreateUser.onclick = async () => {
        if (editingUserId) {
          alert('Finalize ou cancele a edição atual antes de criar um novo usuário.');
          return;
        }
        if (currentUser.role !== 'admin') return;
        const username = val('u-username');
        const password = passwordInput ? passwordInput.value : '';
        const name = val('u-name');
        const whatsapp = whatsappInput ? whatsappInput.value.trim() : '';
        if (!username || !password) {
          alert('Preencha pelo menos o usuário e a senha inicial.');
          return;
        }
        if (password.length < 4) {
          alert('A senha deve ter ao menos 4 caracteres.');
          return;
        }
        if (!isValidWhatsapp(whatsapp)) {
          alert('Informe um número de WhatsApp válido no formato internacional, por exemplo: +5511999999999.');
          return;
        }
        try {
          await apiRequest('/api/users', {
            method: 'POST',
            body: JSON.stringify({
              username,
              password,
              name: name || null,
              whatsapp: whatsapp || null
            })
          });
          await loadManagedUsers();
          alert(`Usuário ${username} criado com sucesso!`);
          resetUserForm();
        } catch (err) {
          if (err?.status === 409) {
            alert('Já existe um usuário com esse nome.');
            return;
          }
          showError('Erro ao criar usuário.', err);
        }
      };
    }

    if (btnClearUser) {
      btnClearUser.onclick = () => {
        resetUserForm();
      };
    }

    if (btnUpdateUser) {
      btnUpdateUser.onclick = async () => {
        if (!editingUserId) {
          alert('Selecione um usuário para editar.');
          return;
        }
        const username = val('u-username');
        const name = val('u-name');
        const whatsapp = whatsappInput ? whatsappInput.value.trim() : '';
        if (!username) {
          alert('O usuário é obrigatório.');
          return;
        }
        const payload = {
          username,
          name: name || null,
          whatsapp: whatsapp || null
        };
        if (passwordInput) {
          const newPassword = passwordInput.value;
          if (newPassword) {
            if (newPassword.length < 4) {
              alert('A nova senha deve ter ao menos 4 caracteres.');
              return;
            }
            payload.password = newPassword;
          }
        }
        try {
          await apiRequest(`/api/users/${encodeURIComponent(editingUserId)}`, {
            method: 'PATCH',
            body: JSON.stringify(payload)
          });
          await loadManagedUsers();
          alert('Usuário atualizado com sucesso!');
          resetUserForm();
        } catch (err) {
          if (err?.status === 409) {
            alert('Já existe um usuário com esse nome.');
            return;
          }
          showError('Erro ao atualizar usuário.', err);
        }
      };
    }

    // boot
    async function boot(){
      await detectApiBase();
      await loadTransactions();
      await loadEvents();
    }
    boot();
  </script>
</body>
</html>
