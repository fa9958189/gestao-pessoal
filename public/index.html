<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gest√£o Pessoal üí∞</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <!-- ===================== LOGIN ===================== -->
    <section id="loginScreen" class="screen active">
      <div class="login-box">
        <h1>Gest√£o Pessoal üí∞</h1>
        <p class="subtitle">Acesse sua conta</p>
        <form id="loginForm">
          <input type="text" id="username" placeholder="Usu√°rio" required />
          <input type="password" id="password" placeholder="Senha" required />
          <button type="submit" class="btn">Entrar</button>
        </form>
        <p id="loginError" class="error hidden">Usu√°rio ou senha inv√°lidos.</p>
      </div>
    </section>

    <!-- ===================== DASHBOARD ===================== -->
    <section id="dashboard" class="screen">
      <header class="topbar">
        <h1>Gest√£o Pessoal</h1>
        <nav>
          <button id="btnAddTransaction" class="pill">+ Nova Transa√ß√£o</button>
          <button id="btnViewSummary" class="pill">Resumo</button>
          <button id="btnLogout" class="pill danger">Sair</button>
        </nav>
      </header>

      <main class="container">
        <!-- BALAN√áO -->
        <section class="panel balance">
          <h2>Resumo Financeiro</h2>
          <div class="balance-cards">
            <div class="card income">
              <h3>Entradas</h3>
              <p id="totalIncome">R$ 0,00</p>
            </div>
            <div class="card expense">
              <h3>Sa√≠das</h3>
              <p id="totalExpense">R$ 0,00</p>
            </div>
            <div class="card balance-total">
              <h3>Saldo</h3>
              <p id="balanceValue">R$ 0,00</p>
            </div>
          </div>
        </section>

        <!-- LISTAGEM -->
        <section class="panel list">
          <h2>Transa√ß√µes</h2>
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </main>
    </section>

    <!-- ===================== NOVA TRANSA√á√ÉO ===================== -->
    <section id="transactionScreen" class="screen">
      <header class="topbar">
        <h1>Nova Transa√ß√£o</h1>
        <nav>
          <button id="btnBackDashboard" class="pill">‚Üê Voltar</button>
        </nav>
      </header>

      <main class="container">
        <form id="transactionForm" class="form">
          <label>
            Tipo:
            <select id="type" required>
              <option value="income">Entrada</option>
              <option value="expense">Sa√≠da</option>
            </select>
          </label>

          <label>
            Valor:
            <input type="number" id="amount" step="0.01" min="0" required />
          </label>

          <label>
            Descri√ß√£o:
            <input type="text" id="description" placeholder="Ex: Sal√°rio, Conta de luz..." />
          </label>

          <label>
            Categoria:
            <input type="text" id="category" placeholder="Ex: Casa, Lazer, Trabalho..." />
          </label>

          <label>
            Data:
            <input type="date" id="date" required />
          </label>

          <button type="submit" class="btn">Salvar</button>
        </form>
      </main>
    </section>

    <!-- ===================== RESUMO ===================== -->
    <section id="summaryScreen" class="screen">
      <header class="topbar">
        <h1>Resumo</h1>
        <nav>
          <button id="btnBackSummary" class="pill">‚Üê Voltar</button>
        </nav>
      </header>

      <main class="container">
        <div class="panel">
          <h2>Resumo Geral</h2>
          <div id="summaryData">
            <p><strong>Entradas:</strong> <span id="sumIncome">R$ 0,00</span></p>
            <p><strong>Sa√≠das:</strong> <span id="sumExpense">R$ 0,00</span></p>
            <p><strong>Saldo:</strong> <span id="sumBalance">R$ 0,00</span></p>
          </div>
        </div>
      </main>
    </section>

    <script>
      // ===================== API =====================
      const API = {
        base: "",
        async login(username, password) {
          const res = await fetch(`/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          if (!res.ok) throw new Error("Login falhou");
          return res.json();
        },
        async listTransactions() {
          const res = await fetch(`/api/transactions`);
          return res.json();
        },
        async createTransaction(data) {
          const res = await fetch(`/api/transactions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          return res.json();
        },
        async deleteTransaction(id) {
          await fetch(`/api/transactions/${id}`, { method: "DELETE" });
        },
        async summary() {
          const res = await fetch(`/api/transactions/summary`);
          return res.json();
        },
      };

      // ===================== DOM HELPERS =====================
      const screens = document.querySelectorAll(".screen");
      const showScreen = (id) => {
        screens.forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
      };

      const fmt = (n) =>
        n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

      // ===================== LOGIN =====================
      const loginForm = document.getElementById("loginForm");
      const loginError = document.getElementById("loginError");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        try {
          const result = await API.login(username, password);
          localStorage.setItem("user", JSON.stringify(result.user));
          showDashboard();
        } catch {
          loginError.classList.remove("hidden");
        }
      });

      const btnLogout = document.getElementById("btnLogout");
      btnLogout.addEventListener("click", () => {
        localStorage.removeItem("user");
        showScreen("loginScreen");
      });

      // ===================== DASHBOARD =====================
      async function showDashboard() {
        showScreen("dashboard");
        const rows = await API.listTransactions();
        const tbody = document.querySelector("#transactionsTable tbody");
        tbody.innerHTML = "";

        let totalIncome = 0;
        let totalExpense = 0;

        rows.forEach((r) => {
          const tr = document.createElement("tr");
          const value = r.type === "income" ? r.amount : -r.amount;
          if (r.type === "income") totalIncome += r.amount;
          else totalExpense += r.amount;

          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.description || "-"}</td>
            <td>${r.category || "-"}</td>
            <td>${r.type === "income" ? "Entrada" : "Sa√≠da"}</td>
            <td class="${r.type}">${fmt(value)}</td>
            <td><button class="del" data-id="${r.id}">üóëÔ∏è</button></td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById("totalIncome").textContent = fmt(totalIncome);
        document.getElementById("totalExpense").textContent = fmt(totalExpense);
        document.getElementById("balanceValue").textContent = fmt(
          totalIncome - totalExpense
        );

        // deletar transa√ß√£o
        tbody.addEventListener("click", async (e) => {
          if (e.target.matches(".del")) {
            const id = e.target.dataset.id;
            await API.deleteTransaction(id);
            showDashboard();
          }
        });
      }

      // ===================== NOVA TRANSA√á√ÉO =====================
      document
        .getElementById("btnAddTransaction")
        .addEventListener("click", () => showScreen("transactionScreen"));
      document
        .getElementById("btnBackDashboard")
        .addEventListener("click", showDashboard);

      document
        .getElementById("transactionForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            type: document.getElementById("type").value,
            amount: parseFloat(document.getElementById("amount").value),
            description: document.getElementById("description").value,
            category: document.getElementById("category").value,
            date: document.getElementById("date").value,
          };
          await API.createTransaction(data);
          showDashboard();
        });

      // ===================== RESUMO =====================
      document
        .getElementById("btnViewSummary")
        .addEventListener("click", async () => {
          showScreen("summaryScreen");
          const s = await API.summary();
          document.getElementById("sumIncome").textContent = fmt(s.income);
          document.getElementById("sumExpense").textContent = fmt(s.expense);
          document.getElementById("sumBalance").textContent = fmt(s.balance);
        });

      document
        .getElementById("btnBackSummary")
        .addEventListener("click", showDashboard);

      // ===================== AUTO LOGIN =====================
      window.addEventListener("DOMContentLoaded", async () => {
        const user = localStorage.getItem("user");
        if (user) showDashboard();
        else showScreen("loginScreen");
      });
    </script>
  </body>
</html>
