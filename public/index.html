<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestão Pessoal – Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Gestão Pessoal – Dashboard</h1>
    <div class="muted">API: <span id="apiUrl">http://localhost:3333</span></div>
  </header>

  <div class="container">
    <!-- COLUNA ESQUERDA: Transações -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 class="title">Transações</h2>
        <div class="tabs">
          <button class="tab active" data-tab="tab-form">Cadastro</button>
          <button class="tab" data-tab="tab-reports">Relatórios</button>
        </div>
      </div>

      <!-- Tab: Cadastro -->
      <div id="tab-form">
        <div class="row">
          <div style="flex:1">
            <label>Tipo</label>
            <select id="t-type">
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Valor (use ponto para decimais)</label>
            <input type="number" step="0.01" id="t-amount" placeholder="0.00">
          </div>
          <div style="flex:1">
            <label>Data</label>
            <input type="date" id="t-date">
          </div>
        </div>
        <div class="row">
          <div style="flex:2">
            <label>Descrição</label>
            <input id="t-desc" placeholder="Ex.: Venda no Pix">
          </div>
          <div style="flex:1">
            <label>Categoria</label>
            <input id="t-cat" placeholder="Ex.: Vendas/Estoque">
          </div>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="primary" id="btnAddTx">Adicionar</button>
          <button class="ghost" id="btnClearTx">Limpar</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div style="flex:1">
            <label>Filtro: de</label>
            <input type="date" id="f-from">
          </div>
          <div style="flex:1">
            <label>até</label>
            <input type="date" id="f-to">
          </div>
          <div style="flex:1">
            <label>Tipo</label>
            <select id="f-type">
              <option value="">Todos</option>
              <option value="income">Receita</option>
              <option value="expense">Despesa</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Busca</label>
            <input id="f-q" placeholder="descrição ou categoria">
          </div>
          <div style="align-self:flex-end">
            <button id="btnFilter">Filtrar</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="summary">
          <div class="kpi">
            <small>Total Receitas</small>
            <strong id="kpiIncome">R$ 0,00</strong>
          </div>
          <div class="kpi">
            <small>Total Despesas</small>
            <strong id="kpiExpense">R$ 0,00</strong>
          </div>
          <div class="kpi">
            <small>Saldo</small>
            <strong id="kpiBalance">R$ 0,00</strong>
          </div>
        </div>

        <div class="sep"></div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th class="right">Valor</th>
                <th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="txTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Tab: Relatórios -->
      <div id="tab-reports" class="hidden">
        <p class="muted">Os gráficos respeitam os filtros de período e busca acima. Clique em <b>Filtrar</b> para atualizar.</p>
        <div class="row">
          <div class="card" style="flex:1">
            <h3 class="title">Receitas x Despesas (por mês)</h3>
            <canvas id="chartLine"></canvas>
          </div>
          <div class="card" style="flex:1">
            <h3 class="title">Despesas por Categoria</h3>
            <canvas id="chartPie"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- COLUNA DIREITA: Agenda -->
    <aside class="card">
      <h2 class="title">Agenda</h2>

      <div class="grid grid-2" style="margin-bottom:8px">
        <div>
          <label>Título</label>
          <input id="e-title" placeholder="Reunião, Médico, etc.">
        </div>
        <div>
          <label>Data</label>
          <input type="date" id="e-date">
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>Início</label>
          <input type="time" id="e-start">
        </div>
        <div>
          <label>Fim</label>
          <input type="time" id="e-end">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Notas</label>
        <textarea id="e-notes" placeholder="Observações do evento..."></textarea>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button class="primary" id="btnAddEvent">Adicionar Evento</button>
        <button class="ghost" id="btnClearEvent">Limpar</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1">
          <label>De</label>
          <input type="date" id="ef-from">
        </div>
        <div style="flex:1">
          <label>Até</label>
          <input type="date" id="ef-to">
        </div>
        <div style="flex:1">
          <label>Busca</label>
          <input id="ef-q" placeholder="título/notas">
        </div>
        <div style="align-self:flex-end">
          <button id="btnFilterEvents">Filtrar</button>
        </div>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto; max-height:480px">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Título</th>
              <th>Horário</th>
              <th>Notas</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="evTable"></tbody>
        </table>
      </div>
    </aside>
  </div>

  <script>
    const API = location.origin; // mesmo host (http://localhost:3333)
    document.getElementById('apiUrl').textContent = API;

    const BRL = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const val = id => document.getElementById(id).value.trim();
    const set = (id,v)=> document.getElementById(id).value = v || '';
    const today = () => new Date().toISOString().slice(0,10);

    // datas padrão
    set('t-date', today());
    set('e-date', today());
    set('f-from', new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10));
    set('f-to', new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).toISOString().slice(0,10));
    set('ef-from', today());
    set('ef-to', today());

    // ===== TABS =====
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-tab');
        document.getElementById('tab-form').classList.toggle('hidden', target!=='tab-form');
        document.getElementById('tab-reports').classList.toggle('hidden', target!=='tab-reports');
        if(target==='tab-reports') updateCharts(); // atualiza gráficos ao abrir
      };
    });

    // ===== TRANSAÇÕES =====
    let cachedTx = [];
    async function loadTransactions(){
      const qs = new URLSearchParams();
      const from = val('f-from'); const to = val('f-to'); const type = val('f-type'); const q = val('f-q');
      if(from) qs.append('from', from);
      if(to) qs.append('to', to);
      if(type) qs.append('type', type);
      if(q) qs.append('q', q);

      const res = await fetch(`${API}/api/transactions?${qs.toString()}`);
      const data = await res.json();
      renderTx(data);
      await loadSummary(from, to);
      cachedTx = data; // para gráficos
    }

    function renderTx(rows){
      const tb = document.getElementById('txTable');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const badge = `<span class="pill ${r.type}">${r.type === 'income' ? 'Receita' : 'Despesa'}</span>`;
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${badge}</td>
          <td>${r.description ?? ''}</td>
          <td>${r.category ?? ''}</td>
          <td class="right">${BRL(r.amount)}</td>
          <td class="actions">
            <button data-edit="${r.id}">Editar</button>
            <button class="danger" data-del="${r.id}">Excluir</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      // delete
      tb.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(!confirm('Excluir esta transação?')) return;
          await fetch(`${API}/api/transactions/${id}`, { method:'DELETE' });
          loadTransactions();
        };
      });
      // edit
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-edit');
          const r = cachedTx.find(x=>x.id===id);
          if(!r) return;
          const type = prompt("Tipo (income/expense):", r.type) || r.type;
          const amount = parseFloat(prompt("Valor:", r.amount)) || r.amount;
          const description = prompt("Descrição:", r.description ?? '') ?? r.description;
          const category = prompt("Categoria:", r.category ?? '') ?? r.category;
          const date = prompt("Data (yyyy-mm-dd):", r.date) || r.date;
          await fetch(`${API}/api/transactions/${id}`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ type, amount, description, category, date })
          });
          loadTransactions();
        };
      });
    }

    async function loadSummary(from, to){
      const qs = new URLSearchParams();
      if(from) qs.append('from', from);
      if(to) qs.append('to', to);
      const res = await fetch(`${API}/api/transactions/summary?${qs.toString()}`);
      const s = await res.json();
      document.getElementById('kpiIncome').textContent  = BRL(s.income);
      document.getElementById('kpiExpense').textContent = BRL(s.expense);
      document.getElementById('kpiBalance').textContent = BRL(s.balance);
    }

    document.getElementById('btnAddTx').onclick = async () => {
      const type = val('t-type');
      const amount = parseFloat(val('t-amount'));
      const date = val('t-date');
      if(!date || isNaN(amount) || amount < 0){ alert('Preenche a data e um valor válido.'); return; }
      const payload = {
        type, amount,
        description: val('t-desc') || null,
        category: val('t-cat') || null,
        date
      };
      await fetch(`${API}/api/transactions`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      set('t-amount',''); set('t-desc',''); set('t-cat','');
      loadTransactions();
    };

    document.getElementById('btnClearTx').onclick = () => {
      set('t-amount',''); set('t-desc',''); set('t-cat',''); set('t-date', today()); set('t-type','income');
    };
    document.getElementById('btnFilter').onclick = ()=>{ loadTransactions(); updateCharts(); };

    // ===== EVENTOS =====
    async function loadEvents(){
      const qs = new URLSearchParams();
      const from = val('ef-from'); const to = val('ef-to'); const q = val('ef-q');
      if(from) qs.append('from', from);
      if(to) qs.append('to', to);
      if(q) qs.append('q', q);

      const res = await fetch(`${API}/api/events?${qs.toString()}`);
      const data = await res.json();
      renderEvents(data);
    }

    function renderEvents(rows){
      const tb = document.getElementById('evTable');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const hora = [r.start_time||'', r.end_time?`– ${r.end_time}`:''].join(' ').trim();
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.title}</td>
          <td>${hora || '-'}</td>
          <td>${r.notes ?? ''}</td>
          <td class="actions">
            <button data-edit="${r.id}">Editar</button>
            <button class="danger" data-del="${r.id}">Excluir</button>
          </td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(!confirm('Excluir este evento?')) return;
          await fetch(`${API}/api/events/${id}`, { method:'DELETE' });
          loadEvents();
        };
      });
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-edit');
          const r = rows.find(x=>x.id===id);
          if(!r) return;
          const title = prompt("Título:", r.title) ?? r.title;
          const date  = prompt("Data (yyyy-mm-dd):", r.date) || r.date;
          const start_time = prompt("Início (HH:mm):", r.start_time ?? '') || null;
          const end_time   = prompt("Fim (HH:mm):", r.end_time ?? '') || null;
          const notes = prompt("Notas:", r.notes ?? '') ?? r.notes;
          await fetch(`${API}/api/events/${id}`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ title, date, start_time, end_time, notes })
          });
          loadEvents();
        };
      });
    }

    // ===== GRÁFICOS (Chart.js) =====
    let chartLine, chartPie;

    function groupByMonth(rows){
      const map = new Map();
      rows.forEach(r=>{
        const ym = r.date.slice(0,7);
        if(!map.has(ym)) map.set(ym, { income:0, expense:0 });
        map.get(ym)[r.type] += r.amount;
      });
      const labels = Array.from(map.keys()).sort();
      const incomes = labels.map(l => map.get(l).income);
      const expenses = labels.map(l => map.get(l).expense);
      return { labels, incomes, expenses };
    }

    function expenseByCategory(rows){
      const cat = {};
      rows.filter(r=>r.type==='expense').forEach(r=>{
        const c = r.category || 'Sem categoria';
        cat[c] = (cat[c]||0) + r.amount;
      });
      const labels = Object.keys(cat);
      const values = labels.map(k => cat[k]);
      return { labels, values };
    }

    function destroyCharts(){
      if(chartLine){ chartLine.destroy(); chartLine=null; }
      if(chartPie){ chartPie.destroy(); chartPie=null; }
    }

    function updateCharts(){
      destroyCharts();
      const rows = [...document.querySelectorAll('#txTable tr')].map(tr=>{
        const tds = tr.querySelectorAll('td');
        return {
          date: tds[0]?.textContent.trim(),
          type: tds[1]?.textContent.includes('Receita') ? 'income' : 'expense',
          description: tds[2]?.textContent.trim(),
          category: tds[3]?.textContent.trim(),
          amount: +tds[4]?.textContent.replace(/[R$\.\s]/g,'').replace(',','.') || 0
        };
      });

      const { labels, incomes, expenses } = groupByMonth(rows);
      const pieData = expenseByCategory(rows);

      const ctxL = document.getElementById('chartLine');
      const ctxP = document.getElementById('chartPie');

      chartLine = new Chart(ctxL, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Receitas', data: incomes },
            { label: 'Despesas', data: expenses }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#e5e7eb' } } },
          scales: {
            x: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } },
            y: { ticks: { color: '#aab2c0' }, grid:{ color:'#1f2434' } }
          }
        }
      });

      chartPie = new Chart(ctxP, {
        type: 'doughnut',
        data: { labels: pieData.labels, datasets: [{ data: pieData.values }] },
        options: { responsive: true, plugins: { legend: { labels: { color: '#e5e7eb' } } } }
      });
    }

    // boot
    async function boot(){
      await loadTransactions();
      await loadEvents();
    }
    boot();
  </script>
</body>
</html>
